"""
=================================================================
ğŸ§  AE WIKI - ë©”ì¸ ì±—ë´‡ í˜ì´ì§€ (pages/2_ğŸ§ _AE_WIKI_ì±—ë´‡.py)
=================================================================

ğŸ“‹ íŒŒì¼ ì—­í• :
- AEíŒ€ ì—…ë¬´ ì§€ì‹ ì „ë¬¸ ì±—ë´‡ì˜ ë©”ì¸ ì¸í„°í˜ì´ìŠ¤
- Confluence ë¬¸ì„œ ê¸°ë°˜ RAG ê²€ìƒ‰ìœ¼ë¡œ ì •í™•í•œ ì—…ë¬´ ê°€ì´ë“œ ì œê³µ  
- ì‹¤ì‹œê°„ ëŒ€í™” ë§¥ë½ ê´€ë¦¬ë¡œ ì—°ì†ì ì¸ ì§ˆì˜ì‘ë‹µ ì§€ì›
- ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ë° ì¶œì²˜ í‘œì‹œë¡œ í–¥ìƒëœ ì‚¬ìš©ì ê²½í—˜

ğŸ”— ì£¼ìš” ì»´í¬ë„ŒíŠ¸:
- ì±„íŒ… ì¸í„°í˜ì´ìŠ¤: ì§ˆë¬¸ ì…ë ¥ í¼ + ëŒ€í™” ê¸°ë¡ í‘œì‹œ
- RAG ê²€ìƒ‰: Confluence ë¬¸ì„œ ì¸ë±ìŠ¤ (rp-conflu_1) ê¸°ë°˜ ì •ë³´ ê²€ìƒ‰
- ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ: ì‹¤ì‹œê°„ íƒ€ì´í•‘ íš¨ê³¼ë¡œ ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™” ê²½í—˜
- ì¶œì²˜ í‘œì‹œ: í´ë¦­ ê°€ëŠ¥í•œ Confluence URLë¡œ ì›ë³¸ ë¬¸ì„œ ì ‘ê·¼

ğŸ“Š ì…ì¶œë ¥ ë°ì´í„°:
- ì…ë ¥: ì‚¬ìš©ì ì§ˆë¬¸ (AEíŒ€ ì—…ë¬´, ì œí’ˆ ì •ë³´, í”„ë¡œì„¸ìŠ¤ ë¬¸ì˜ ë“±)
- ì¶œë ¥: RAG ê²€ìƒ‰ ê¸°ë°˜ ë‹µë³€ + Confluence ë¬¸ì„œ ì¶œì²˜ ë§í¬
- ì €ì¥: chat_historyì— ëŒ€í™” ê¸°ë¡ ëˆ„ì  (knowledge_data.json)

ğŸ”„ ì—°ë™ ê´€ê³„:
- utils.py: get_chatbot_response(chatbot_type="ae_wiki") í˜¸ì¶œ
- config.py: ae_wiki_chatbot í”„ë¡¬í”„íŠ¸ ë° ì¸ë±ìŠ¤ ì„¤ì • ì°¸ì¡°
- conversation_manager.py: ëŒ€í™” ë§¥ë½ ê´€ë¦¬ (ìµœê·¼ 10í„´)
- RAG API: rp-conflu_1 ì¸ë±ìŠ¤ì—ì„œ ê´€ë ¨ ë¬¸ì„œ ê²€ìƒ‰

âš¡ ì²˜ë¦¬ íë¦„:
ì§ˆë¬¸ ì…ë ¥ -> RAG ê²€ìƒ‰ (Confluence ë¬¸ì„œ) -> LLM ë‹µë³€ ìƒì„± (ae_wiki í”„ë¡¬í”„íŠ¸) 
-> ìŠ¤íŠ¸ë¦¬ë° í‘œì‹œ -> ì¶œì²˜ ë§í¬ ì¶”ê°€ -> ëŒ€í™” ê¸°ë¡ ì €ì¥

ğŸ¯ ì „ë¬¸ ì˜ì—­:
- AEíŒ€ ì—…ë¬´ í”„ë¡œì„¸ìŠ¤ ë° ê°€ì´ë“œë¼ì¸
- ë°˜ë„ì²´ ì œí’ˆ ì‚¬ì–‘ ë° ê¸°ìˆ  ë¬¸ì„œ  
- ê³ ê° ì§€ì› ì ˆì°¨ ë° ë¬¸ì œ í•´ê²° ë°©ë²•
- ë‚´ë¶€ ìœ„í‚¤ ë° ì»¨í”Œë£¨ì–¸ìŠ¤ ë¬¸ì„œ ë‚´ìš©
"""

import streamlit as st
import time
from datetime import datetime

from config import APP_CONFIG, MISC_CONFIG
from utils import (
    initialize_data, get_chatbot_response, save_chat_history, load_css_styles,
    require_login, initialize_session_state
)

# ====================================
# ğŸ¨ í˜ì´ì§€ ì„¤ì • ë° ìŠ¤íƒ€ì¼
# ====================================

st.set_page_config(
    page_title=f"AE WIKI ì±—ë´‡ - {APP_CONFIG['page_title']}",
    page_icon="ğŸ§ ",
    layout=APP_CONFIG["layout"],
    initial_sidebar_state=APP_CONFIG["initial_sidebar_state"]
)

# CSS ìŠ¤íƒ€ì¼ ë¡œë“œ
# ë‹¤í¬ í…Œë§ˆ ì ìš©
from theme import apply_dark_theme
apply_dark_theme()

# ====================================
# ğŸ¯ ë©”ì¸ í•¨ìˆ˜
# ====================================

def main():
    # ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” ë° ë¡œê·¸ì¸ ìƒíƒœ ë³µì›
    initialize_session_state()
    
    # ë¡œê·¸ì¸ í™•ì¸
    if not require_login():
        return
    
    # ë°ì´í„° ì´ˆê¸°í™”
    data = initialize_data()
    
    # AE WIKI ì±—ë´‡ í˜ì´ì§€ í‘œì‹œ
    show_ae_wiki_chatbot_page(data)

def show_ae_wiki_chatbot_page(data):
    """AE WIKI ì±—ë´‡ ë©”ì¸ í˜ì´ì§€"""
    
    # í†µí•© í—¤ë” ë° ì•ˆë‚´ ë©”ì‹œì§€
    st.markdown("""
    <div style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); 
               padding: 2rem; border-radius: 15px; color: white; margin-bottom: 2rem; text-align: center;">
        <h1 style="color: white; text-align: center; margin-bottom: 0.5rem; font-size: 2.5rem;">ğŸ§  AE WIKI ì±—ë´‡</h1>
        <p style="color: #e6e6ff; font-size: 1.3rem; margin-bottom: 1.5rem;">AEíŒ€ ì—…ë¬´ ì „ë¬¸ AI ì–´ì‹œìŠ¤í„´íŠ¸</p>
        <h4 style="color: white; text-align: center; margin-bottom: 1rem;">ğŸ§  AEíŒ€ ì—…ë¬´ ì „ë¬¸ ìƒë‹´</h4>
        <p style="margin-bottom: 0.5rem; color: white; text-align: center;">â€¢ AEíŒ€ ì—…ë¬´ í”„ë¡œì„¸ìŠ¤ ë° ê°€ì´ë“œë¼ì¸</p>

    </div>
    """, unsafe_allow_html=True)
    
    # ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
    if "ae_wiki_chat_messages" not in st.session_state:
        st.session_state.ae_wiki_chat_messages = []
        # ì´ˆê¸° ì¸ì‚¬ë§
        welcome_message = {
            "role": "assistant", 
            "content": """ì•ˆë…•í•˜ì„¸ìš”! AE WIKI ì „ë¬¸ ì±—ë´‡ì…ë‹ˆë‹¤. ğŸ§ 

ì €ëŠ” AEíŒ€ ì—…ë¬´ ì „ë¬¸ ë¬¸ì„œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì§ˆë¬¸ì— ë‹µë³€ë“œë¦½ë‹ˆë‹¤.

**ë„ì›€ì„ ë“œë¦´ ìˆ˜ ìˆëŠ” ë¶„ì•¼:**
- ğŸ¢ AEíŒ€ ì—…ë¬´ í”„ë¡œì„¸ìŠ¤ ë° ê°€ì´ë“œë¼ì¸
- ğŸ”§ ë°˜ë„ì²´ ì œí’ˆ ì‚¬ì–‘ ë° ê¸°ìˆ  ë¬¸ì„œ
- ğŸ¯ ê³ ê° ì§€ì› ì ˆì°¨ ë° ë¬¸ì œ í•´ê²° ë°©ë²•
- ğŸ“š ë‚´ë¶€ ìœ„í‚¤ ë° ì»¨í”Œë£¨ì–¸ìŠ¤ ë¬¸ì„œ ë‚´ìš©
- ğŸ’¡ ì—…ë¬´ íš¨ìœ¨ì„± í–¥ìƒì„ ìœ„í•œ íŒ

ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ì§ˆë¬¸í•´ì£¼ì„¸ìš”!""",
            "timestamp": datetime.now().strftime("%H:%M:%S")
        }
        st.session_state.ae_wiki_chat_messages.append(welcome_message)

    # ì±„íŒ… ë©”ì‹œì§€ í‘œì‹œ (ê¸°ì¡´ ëŒ€í™” ê¸°ë¡)
    for message in st.session_state.ae_wiki_chat_messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])
            st.caption(f"â° {message['timestamp']}")

    # ì±„íŒ… ì…ë ¥ ì²˜ë¦¬
    if prompt := st.chat_input("AEíŒ€ ì—…ë¬´ì— ëŒ€í•´ ê¶ê¸ˆí•œ ê²ƒì„ ì§ˆë¬¸í•´ë³´ì„¸ìš”..."):
        # ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        timestamp = datetime.now().strftime("%H:%M:%S")
        st.session_state.ae_wiki_chat_messages.append({
            "role": "user", 
            "content": prompt,
            "timestamp": timestamp
        })
        
        # ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
        with st.chat_message("user"):
            st.markdown(prompt)
            st.caption(f"â° {timestamp}")

        # AI ì‘ë‹µ ìƒì„± ë° í‘œì‹œ
        with st.chat_message("assistant"):
            # ì´ì „ ëŒ€í™” ë§¥ë½ë§Œ ì‚¬ìš© (í˜„ì¬ ì…ë ¥ ì œì™¸)
            previous_messages = st.session_state.ae_wiki_chat_messages[:-1]
            
            # ì‘ë‹µ ìƒì„±
            from utils import get_user_id
            bot_response = get_chatbot_response(
                prompt, 
                chat_history=None,  # ë‹¨ìˆœí™”
                chatbot_type="ae_wiki",
                user_id=get_user_id()
            )
            
            # AI ì‘ë‹µ í‘œì‹œ
            st.markdown(bot_response)
            response_timestamp = datetime.now().strftime("%H:%M:%S")
            st.caption(f"â° {response_timestamp}")

        # AI ì‘ë‹µì„ ì„¸ì…˜ ìƒíƒœì— ì €ì¥
        st.session_state.ae_wiki_chat_messages.append({
            "role": "assistant",
            "content": bot_response,
            "timestamp": response_timestamp
        })
        
        # ì±„íŒ… íˆìŠ¤í† ë¦¬ë¥¼ knowledge_data.jsonì— ì €ì¥
        save_chat_history(data, prompt, bot_response, chatbot_type="ae_wiki")
    
    # ì‚¬ì´ë“œë°”: ì±„íŒ… ê´€ë¦¬
    with st.sidebar:
        st.markdown("### ğŸ”§ ì±„íŒ… ê´€ë¦¬")
        
        if st.button("ğŸ—‘ï¸ ëŒ€í™” ê¸°ë¡ ì´ˆê¸°í™”", use_container_width=True):
            st.session_state.ae_wiki_chat_messages = []
            st.success("ëŒ€í™” ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!")
            time.sleep(0.5)
            st.rerun()


# ====================================
# ğŸš€ ì•± ì‹¤í–‰
# ====================================

if __name__ == "__main__":
    main()