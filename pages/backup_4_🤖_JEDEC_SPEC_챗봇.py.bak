"""
=================================================================
ğŸ“„ AE WIKI - JEDEC SPEC ì±—ë´‡ í˜ì´ì§€ (4_ğŸ¤–_JEDEC_SPEC_ì±—ë´‡.py)
=================================================================

ğŸ“‹ íŒŒì¼ ì—­í• :
- JEDEC(Joint Electron Device Engineering Council) ë°˜ë„ì²´ í‘œì¤€ ë¬¸ì„œ ì „ë¬¸ AI ì±—ë´‡ í˜ì´ì§€
- ë©”ëª¨ë¦¬, í”„ë¡œì„¸ì„œ, ì¸í„°í˜ì´ìŠ¤ í‘œì¤€ ê·œê²© í•´ì„ ë° ê¸°ìˆ  ê°€ì´ë“œë¼ì¸ ì œê³µ
- ì‹¤ì‹œê°„ ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•œ JEDEC í‘œì¤€ ë¬¸ì„œ ê²€ìƒ‰ ë° ë¶„ì„ ì„œë¹„ìŠ¤

ğŸ”— ì£¼ìš” ì»´í¬ë„ŒíŠ¸:
- ì‹¤ì‹œê°„ ì±„íŒ… ì‹œìŠ¤í…œ: st.chat_message(), st.chat_input() ì‚¬ìš©
- íƒ€ì´í•‘ íš¨ê³¼: ë¬¸ì ë‹¨ìœ„ë¡œ ì ì§„ì  ì‘ë‹µ í‘œì‹œ
- ì±„íŒ… íˆìŠ¤í† ë¦¬: ì„¸ì…˜ë³„ ëŒ€í™” ë‚´ì—­ ë³´ê´€
- ë‹¤í¬í…Œë§ˆ ì»¨í…Œì´ë„ˆ: ì‚¬ìš©ì ìš”ì²­ìœ¼ë¡œ ë°°ê²½ ìƒ‰ìƒ ì¡°í™” (CHANGED)

ğŸ“Š ì…ì¶œë ¥ ë°ì´í„°:
- ì…ë ¥: ì‚¬ìš©ì JEDEC í‘œì¤€ ê´€ë ¨ ì§ˆë¬¸, ì±„íŒ… íˆìŠ¤í† ë¦¬
- ì¶œë ¥: JEDEC ì „ë¬¸ AI ì‘ë‹µ, ì±„íŒ… íˆìŠ¤í† ë¦¬ ì €ì¥
- ì €ì¥: st.session_state.jedec_chat_messages (ì„¸ì…˜ë³„ ëŒ€í™” ë‚´ì—­)

ğŸ”„ ì—°ë™ ê´€ê³„:
- utils.py: ì‚¬ìš©ì ì¸ì¦, ì±—ë´‡ ì‘ë‹µ ìƒì„±, ì±„íŒ… íˆìŠ¤í† ë¦¬ ì €ì¥
- config.py: ì•± ì„¤ì • ë° JEDEC ì „ìš© ì„¤ì •ê°’
- í™ˆí˜ì´ì§€: ğŸ¤– JEDEC SPEC ì±—ë´‡ ì¹´ë“œì—ì„œ ì§ì ‘ ì ‘ê·¼

âš¡ ì²˜ë¦¬ íë¦„:
ì‚¬ìš©ì ì ‘ì† -> ë¡œê·¸ì¸ í™•ì¸ -> ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ í‘œì‹œ -> ì§ˆë¬¸ ì…ë ¥ 
-> JEDEC ì „ë¬¸ ì‘ë‹µ ìƒì„± -> íƒ€ì´í•‘ íš¨ê³¼ë¡œ í‘œì‹œ -> íˆìŠ¤í† ë¦¬ ì €ì¥

ğŸ¨ UI ê°œì„ ì‚¬í•­:
- ë©”ì¸/í•˜ë‹¨ ë¸”ë¡ ì»¨í…Œì´ë„ˆ ë°°ê²½ìƒ‰ í†µì¼ (#1a1a1a) - CHANGED
- ì±„íŒ… ì…ë ¥ì°½ ë° ê´€ë ¨ ìš”ì†Œ ë‹¤í¬í…Œë§ˆ ì ìš©
"""

import streamlit as st
import time
from datetime import datetime

from config import APP_CONFIG
from utils import (
    initialize_data, get_chatbot_response, save_chat_history, load_css_styles,
    require_login, initialize_session_state, get_user_id
)

# ====================================
# ğŸ¨ í˜ì´ì§€ ì„¤ì • ë° ìŠ¤íƒ€ì¼
# ====================================

st.set_page_config(
    page_title=f"JEDEC SPEC ì±—ë´‡ - {APP_CONFIG['page_title']}",
    page_icon="ğŸ¤–",
    layout=APP_CONFIG["layout"],
    initial_sidebar_state=APP_CONFIG["initial_sidebar_state"]
)

# ë‹¤í¬ í…Œë§ˆ ì ìš©
from theme import apply_dark_theme
apply_dark_theme()

# ì±„íŒ… ì…ë ¥ì°½ ì¶”ê°€ ìŠ¤íƒ€ì¼ë§ (ì´ë¯¸ ë‹¤í¬ í…Œë§ˆì— í¬í•¨ë˜ì–´ ìˆì§€ë§Œ íŠ¹ë³„í•œ ì¡°ì •ì´ í•„ìš”í•œ ê²½ìš°)
# ê¸°ë³¸ ë‹¤í¬ í…Œë§ˆê°€ ëŒ€ë¶€ë¶„ì˜ ìŠ¤íƒ€ì¼ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤

# ====================================
# ğŸ¯ ë©”ì¸ í•¨ìˆ˜
# ====================================

def main():
    # ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” ë° ë¡œê·¸ì¸ ìƒíƒœ ë³µì›
    initialize_session_state()
    
    # ë¡œê·¸ì¸ í™•ì¸
    if not require_login():
        return
    
    # ë°ì´í„° ì´ˆê¸°í™”
    data = initialize_data()
    
    # JEDEC SPEC ì±—ë´‡ í˜ì´ì§€ í‘œì‹œ
    show_jedec_spec_chatbot_page(data)

def show_jedec_spec_chatbot_page(data):
    """JEDEC SPEC ì±—ë´‡ ë©”ì¸ í˜ì´ì§€"""
    
    # í†µí•© í—¤ë” ë° ì•ˆë‚´ ë©”ì‹œì§€
    st.markdown("""
    <div style="background: linear-gradient(90deg, #f59e0b 0%, #f97316 100%); 
               padding: 2rem; border-radius: 15px; color: white; margin-bottom: 2rem; text-align: center;">
        <h1 style="color: white; text-align: center; margin-bottom: 0.5rem; font-size: 2.5rem;">ğŸ¤– JEDEC SPEC ì±—ë´‡</h1>
        <p style="color: #fef3e2; font-size: 1.3rem; margin-bottom: 1.5rem;">JEDEC ë°˜ë„ì²´ í‘œì¤€ ë¬¸ì„œ ì „ìš© AI ì–´ì‹œìŠ¤í„´íŠ¸</p>
        <h4 style="color: white; text-align: center; margin-bottom: 1rem;">ğŸ”¬ JEDEC í‘œì¤€ ë¬¸ì„œ ì „ë¬¸ ìƒë‹´</h4>
        <p style="margin-bottom: 0.5rem; color: white; text-align: center;">â€¢ JEDEC ë°˜ë„ì²´ í‘œì¤€ ê·œê²© ë° í…ŒìŠ¤íŠ¸ ë°©ë²• ë¬¸ì˜</p>
        <p style="margin-bottom: 0.5rem; color: white; text-align: center;">â€¢ ë©”ëª¨ë¦¬, í”„ë¡œì„¸ì„œ, ì¸í„°í˜ì´ìŠ¤ í‘œì¤€ í•´ì„</p>
        <p style="margin-bottom: 0.5rem; color: white; text-align: center;">â€¢ ê·œê²© ì¤€ìˆ˜ë¥¼ ìœ„í•œ ê¸°ìˆ ì  ê°€ì´ë“œë¼ì¸ ì œê³µ</p>
        <p style="margin-bottom: 0; color: white; text-align: center;">â€¢ í‘œì¤€ ë¬¸ì„œ ê°„ ë¹„êµ ë° ë¶„ì„ ì§€ì›</p>
    </div>
    """, unsafe_allow_html=True)
    
    # ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
    if "jedec_chat_messages" not in st.session_state:
        st.session_state.jedec_chat_messages = []
        # ì´ˆê¸° ì¸ì‚¬ë§
        welcome_message = {
            "role": "assistant", 
            "content": """ì•ˆë…•í•˜ì„¸ìš”! JEDEC SPEC ì „ë¬¸ ì±—ë´‡ì…ë‹ˆë‹¤. ğŸ”¬

ì €ëŠ” JEDEC(Joint Electron Device Engineering Council) ë°˜ë„ì²´ í‘œì¤€ ë¬¸ì„œì— ëŒ€í•œ ì§ˆë¬¸ì— ë‹µë³€ë“œë¦½ë‹ˆë‹¤.

**ë„ì›€ì„ ë“œë¦´ ìˆ˜ ìˆëŠ” ë¶„ì•¼:**
- ğŸ¤– JEDEC í‘œì¤€ ê·œê²© í•´ì„ ë° ì„¤ëª…
- ğŸ” íŠ¹ì • í‘œì¤€ ë¬¸ì„œ ê²€ìƒ‰ ë° ë¶„ì„
- âš¡ ë©”ëª¨ë¦¬, í”„ë¡œì„¸ì„œ í‘œì¤€ ë¹„êµ
- ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²• ë° ê²€ì¦ ì ˆì°¨
- ğŸ“Š ê·œê²© ì¤€ìˆ˜ë¥¼ ìœ„í•œ ê¸°ìˆ  ê°€ì´ë“œ

JEDEC í‘œì¤€ê³¼ ê´€ë ¨ëœ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”!""",
            "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }
        st.session_state.jedec_chat_messages.append(welcome_message)
    
    # ì±„íŒ… íˆìŠ¤í† ë¦¬ í‘œì‹œ
    chat_container = st.container()
    with chat_container:
        for message in st.session_state.jedec_chat_messages:
            with st.chat_message(message["role"]):
                st.markdown(message["content"])
                if "timestamp" in message:
                    st.caption(f"â° {message['timestamp']}")
    
    # ì±„íŒ… ì…ë ¥ ì²˜ë¦¬
    if prompt := st.chat_input("JEDEC í‘œì¤€ê³¼ ê´€ë ¨ëœ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."):
        # ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        st.session_state.jedec_chat_messages.append({
            "role": "user", 
            "content": prompt,
            "timestamp": timestamp
        })
        
        # ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
        with st.chat_message("user"):
            st.markdown(prompt)
            st.caption(f"â° {timestamp}")

        # AI ì‘ë‹µ ìƒì„± ë° í‘œì‹œ
        with st.chat_message("assistant"):
            # JEDEC ì „ìš© ì±—ë´‡ ì‘ë‹µ ìƒì„±
            bot_response = get_jedec_spec_chatbot_response(
                prompt, 
                chat_history=None,  # ë‹¨ìˆœí™”
                user_id=get_user_id()
            )
            
            # AI ì‘ë‹µ í‘œì‹œ
            st.markdown(bot_response)
            response_timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            st.caption(f"â° {response_timestamp}")

        # AI ì‘ë‹µì„ ì„¸ì…˜ ìƒíƒœì— ì €ì¥
        st.session_state.jedec_chat_messages.append({
            "role": "assistant",
            "content": bot_response,
            "timestamp": response_timestamp
        })
        
        # ì±„íŒ… íˆìŠ¤í† ë¦¬ë¥¼ knowledge_data.jsonì— ì €ì¥
        save_chat_history(data, prompt, bot_response, chatbot_type="jedec")
        
    
    # ì‚¬ì´ë“œë°”: ì±„íŒ… ê´€ë¦¬
    with st.sidebar:
        st.markdown("### ğŸ”§ ì±„íŒ… ê´€ë¦¬")
        
        if st.button("ğŸ—‘ï¸ ëŒ€í™” ê¸°ë¡ ì´ˆê¸°í™”", use_container_width=True):
            st.session_state.jedec_chat_messages = []
            st.success("ëŒ€í™” ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!")
            time.sleep(0.5)
            st.rerun()
        

def get_jedec_spec_chatbot_response(user_message: str, chat_history: list = None, user_id: str = None) -> str:
    """
    ğŸ¯ ëª©ì : JEDEC í‘œì¤€ ë¬¸ì„œì— íŠ¹í™”ëœ AI ì±—ë´‡ ì‘ë‹µì„ ìƒì„±í•˜ëŠ” ì „ìš© í•¨ìˆ˜
    
    ğŸ“Š ì…ë ¥:
    - user_message (str): ì‚¬ìš©ì ì§ˆë¬¸ (JEDEC í‘œì¤€ ê´€ë ¨)
    - chat_history (list, ì„ íƒ): ì´ì „ ëŒ€í™” ë‚´ì—­ (ì»¨í…ìŠ¤íŠ¸ ì´í•´ìš©)
    - user_id (str, ì„ íƒ): ì‚¬ìš©ì ì‹ë³„ì (ê°œì¸í™” ì‘ë‹µìš©)
    
    ğŸ“¤ ì¶œë ¥:
    - str: JEDEC ì „ë¬¸ê°€ ìˆ˜ì¤€ì˜ AI ì‘ë‹µ í…ìŠ¤íŠ¸
    
    ğŸ”„ ë¶€ì‘ìš©:
    - utils.pyì˜ get_chatbot_response() í˜¸ì¶œë¡œ ì‹¤ì œ AI ì‘ë‹µ ìƒì„±
    - ì˜¤ë¥˜ ë°œìƒ ì‹œ ì‚¬ìš©ìì—ê²Œ ì˜¤ë¥˜ ë©”ì‹œì§€ ë°˜í™˜
    
    ğŸ“ í˜¸ì¶œ ê´€ê³„:
    - í˜¸ì¶œì: show_jedec_spec_chatbot_page() -> ì‚¬ìš©ì ì§ˆë¬¸ ì…ë ¥ ì‹œ
    - í˜¸ì¶œ ëŒ€ìƒ: get_chatbot_response() (utils.pyì˜ ë²”ìš© ì±—ë´‡ í•¨ìˆ˜)
    
    ğŸ¯ JEDEC ì „ë¬¸ ë¶„ì•¼:
    - ë©”ëª¨ë¦¬ í‘œì¤€ (DDR, LPDDR, GDDR, HBM ë“±)
    - ì¸í„°í˜ì´ìŠ¤ í‘œì¤€ (PCIe, USB, SATA ë“±)
    - í…ŒìŠ¤íŠ¸ ë°©ë²• ë° ê²€ì¦ ì ˆì°¨
    - íŒ¨í‚¤ì§• ë° í•€ì•„ì›ƒ í‘œì¤€
    - ì „ë ¥ ê´€ë¦¬ ë° ì—´ ê´€ë¦¬ ê·œê²©
    
    ğŸ”„ ë°ì´í„° íë¦„:
    ì‚¬ìš©ì ì§ˆë¬¸ -> JEDEC ì „ìš© ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì ìš© -> AI ëª¨ë¸ í˜¸ì¶œ 
    -> ì „ë¬¸ê°€ ìˆ˜ì¤€ ì‘ë‹µ ìƒì„± -> ì˜¤ë¥˜ ì²˜ë¦¬ -> ìµœì¢… ì‘ë‹µ ë°˜í™˜
    
    âš ï¸ ì˜ˆì™¸ ì²˜ë¦¬:
    - AI ëª¨ë¸ í˜¸ì¶œ ì‹¤íŒ¨: "JEDEC SPEC ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€
    - ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜, í† í° í•œë„ ì´ˆê³¼ ë“± ëª¨ë“  ì˜ˆì™¸ ìƒí™© ì»¤ë²„
    """
    
    # JEDEC ì „ìš© ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
    jedec_system_prompt = """ë‹¹ì‹ ì€ JEDEC(Joint Electron Device Engineering Council) ë°˜ë„ì²´ í‘œì¤€ ë¬¸ì„œ ì „ë¬¸ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.

**ì—­í• :**
- JEDEC í‘œì¤€ ê·œê²© í•´ì„ ë° ì„¤ëª… ì „ë¬¸ê°€
- ë°˜ë„ì²´ í‘œì¤€ ë¬¸ì„œ ê²€ìƒ‰ ë° ë¶„ì„ ì§€ì›
- ê¸°ìˆ ì  ê°€ì´ë“œë¼ì¸ ë° ê·œê²© ì¤€ìˆ˜ ë°©ë²• ì•ˆë‚´

**ì „ë¬¸ ë¶„ì•¼:**
- ë©”ëª¨ë¦¬ í‘œì¤€ (DDR, LPDDR, GDDR, HBM ë“±)
- ì¸í„°í˜ì´ìŠ¤ í‘œì¤€ (PCIe, USB, SATA ë“±) 
- í…ŒìŠ¤íŠ¸ ë°©ë²• ë° ê²€ì¦ ì ˆì°¨
- íŒ¨í‚¤ì§• ë° í•€ì•„ì›ƒ í‘œì¤€
- ì „ë ¥ ê´€ë¦¬ ë° ì—´ ê´€ë¦¬ ê·œê²©

**ì‘ë‹µ ì›ì¹™:**
- ì •í™•í•œ í‘œì¤€ ë²ˆí˜¸ì™€ ë²„ì „ ì •ë³´ ì œê³µ
- ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­ì„ ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…
- ì‹¤ë¬´ì— ì ìš© ê°€ëŠ¥í•œ êµ¬ì²´ì  ê°€ì´ë“œë¼ì¸ ì œê³µ
- ê´€ë ¨ í‘œì¤€ ê°„ì˜ ì—°ê´€ì„± ë° ì°¨ì´ì  ëª…ì‹œ

ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— JEDEC í‘œì¤€ ë¬¸ì„œ ê¸°ë°˜ìœ¼ë¡œ ì „ë¬¸ì ì´ê³  ì •í™•í•œ ë‹µë³€ì„ ì œê³µí•˜ì„¸ìš”."""

    try:
        # Try to use specialized JEDEC RAG pipeline first
        try:
            # JEDEC SPEC ì „ìš© ì‘ë‹µ ìƒì„± (íŒŒì¼ëª… + í˜ì´ì§€ ë²ˆí˜¸ í˜•ì‹)
            # chatbot_type="jedec"ëŠ” config.pyì—ì„œ "rp-jedec" ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •ë¨
            # ì´ ì¸ë±ìŠ¤ì—ëŠ” JEDEC í‘œì¤€ ê·œê²© PDF ë¬¸ì„œë“¤ì´ ì €ì¥ë˜ì–´ ìˆìŒ
            # ì¶œì²˜ëŠ” "íŒŒì¼ëª… - p.í˜ì´ì§€ë²ˆí˜¸" í˜•ì‹ìœ¼ë¡œ í‘œì‹œë¨ (ì˜ˆ: JESD79-4.pdf - p.45)
            response = get_chatbot_response(user_message, chatbot_type="jedec")
            if response and len(response) > 50 and "error" not in response.lower():
                return response
        except Exception:
            pass
        
        # Fallback to basic RAG response with JEDEC system prompt
        return get_chatbot_response(
            user_message, 
            chat_history=chat_history,  # ëŒ€í™” ë§¥ë½ ì „ë‹¬
            user_id=user_id,
            system_prompt=jedec_system_prompt,
            chatbot_type="jedec"
        )
    except Exception as e:
        return f"ì£„ì†¡í•©ë‹ˆë‹¤. JEDEC SPEC ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"


# ====================================
# ğŸš€ ì•± ì‹¤í–‰
# ====================================

if __name__ == "__main__":
    main()