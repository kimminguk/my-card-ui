"""
=================================================================
ğŸ“„ AE WIKI - AE ìš©ì–´ì§‘ ì±—ë´‡ í˜ì´ì§€ (3_ğŸ”_AE_ìš©ì–´ì§‘_ì±—ë´‡.py)
=================================================================

ğŸ“‹ íŒŒì¼ ì—­í• :
- ë°˜ë„ì²´ AE(Application Engineering) ì „ë¬¸ ìš©ì–´ ê²€ìƒ‰ ë° ì •ì˜ ì œê³µ ì±—ë´‡
- RAG(Retrieval-Augmented Generation) ê¸°ë°˜ ì‹ ë¢°ì„± ë†’ì€ ìš©ì–´ ê²€ìƒ‰ ì‹œìŠ¤í…œ
- ìš©ì–´ ì •ë³´ ë¶€ì¡± ì‹œ "ìˆ˜ì •í•˜ê¸°/ì¶”ê°€í•˜ê¸°" ê¸°ëŠ¥ìœ¼ë¡œ WIKI í•™ìŠµì‹œí‚¤ê¸° í˜ì´ì§€ ì—°ë™

ğŸ”— ì£¼ìš” ì»´í¬ë„ŒíŠ¸:
- ì‹¤ì‹œê°„ ìš©ì–´ ê²€ìƒ‰ ì±„íŒ… ì¸í„°í˜ì´ìŠ¤
- "ìˆ˜ì •í•˜ê¸°/ì¶”ê°€í•˜ê¸°" ë²„íŠ¼ -> WIKI í•™ìŠµì‹œí‚¤ê¸° í˜ì´ì§€ ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸
- ì±„íŒ… íˆìŠ¤í† ë¦¬ ê´€ë¦¬ ë° ì´ˆê¸°í™” ê¸°ëŠ¥

ğŸ“Š ì…ì¶œë ¥ ë°ì´í„°:
- ì…ë ¥: ì‚¬ìš©ì ìš©ì–´ ê²€ìƒ‰ ì§ˆë¬¸
- ì¶œë ¥: ìš©ì–´ ì •ì˜, ì—°ê´€ í‚¤ì›Œë“œ, ì°¸ê³  ìë£Œ
- ì—°ë™: st.session_stateë¡œ WIKI í•™ìŠµì‹œí‚¤ê¸° í˜ì´ì§€ì— ì»¨í…ìŠ¤íŠ¸ ì „ë‹¬

ğŸ”„ ì—°ë™ ê´€ê³„:
- pages/5_âœ¨WIKI_í•™ìŠµì‹œí‚¤ê¸°.py: ìš©ì–´ ìˆ˜ì •/ì¶”ê°€ ë¦¬ë‹¤ì´ë ‰íŠ¸
- utils.py: ìš©ì–´ì§‘ ì „ìš© ì±—ë´‡ ì‘ë‹µ ìƒì„±
- í™ˆí˜ì´ì§€: ğŸ” AE ìš©ì–´ì§‘ ì±—ë´‡ ì¹´ë“œì—ì„œ ì ‘ê·¼

âš¡ ì²˜ë¦¬ íë¦„:
ìš©ì–´ ê²€ìƒ‰ -> RAG ê¸°ë°˜ ì •ë³´ ì¡°íšŒ -> ì‘ë‹µ ìƒì„± -> ë¶€ì¡± ì‹œ ìˆ˜ì •/ì¶”ê°€ ë²„íŠ¼ í‘œì‹œ
-> ë²„íŠ¼ í´ë¦­ ì‹œ WIKI í•™ìŠµ í˜ì´ì§€ë¡œ ì»¨í…ìŠ¤íŠ¸ì™€ í•¨ê»˜ ë¦¬ë‹¤ì´ë ‰íŠ¸
"""

import streamlit as st
import time
from datetime import datetime

from config import APP_CONFIG, MISC_CONFIG
from utils import (
    initialize_data, get_chatbot_response, save_chat_history, load_css_styles,
    require_login, initialize_session_state
)

# ====================================
# ğŸ¨ í˜ì´ì§€ ì„¤ì • ë° ìŠ¤íƒ€ì¼
# ====================================

st.set_page_config(
    page_title=f"AE ìš©ì–´ì§‘ ì±—ë´‡ - {APP_CONFIG['page_title']}",
    page_icon="ğŸ”",
    layout=APP_CONFIG["layout"],
    initial_sidebar_state=APP_CONFIG["initial_sidebar_state"]
)

# ë‹¤í¬ í…Œë§ˆ ì ìš©
from theme import apply_dark_theme
apply_dark_theme()

# ====================================
# ğŸ¯ ë©”ì¸ í•¨ìˆ˜
# ====================================

def main():
    # ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” ë° ë¡œê·¸ì¸ ìƒíƒœ ë³µì›
    initialize_session_state()
    
    # ë¡œê·¸ì¸ í™•ì¸
    if not require_login():
        return
    
    # ë°ì´í„° ì´ˆê¸°í™”
    data = initialize_data()
    
    # AE ìš©ì–´ì§‘ ì±—ë´‡ í˜ì´ì§€ í‘œì‹œ
    show_glossary_chatbot_page(data)

def show_glossary_chatbot_page(data):
    """AE ìš©ì–´ì§‘ ì±—ë´‡ ë©”ì¸ í˜ì´ì§€"""
    
    # í†µí•© í—¤ë” ë° ì•ˆë‚´ ë©”ì‹œì§€
    st.markdown("""
    <div style="background: linear-gradient(90deg, #28a745 0%, #20c997 100%); 
               padding: 2rem; border-radius: 15px; color: white; margin-bottom: 2rem; text-align: center;">
        <h1 style="color: white; text-align: center; margin-bottom: 0.5rem; font-size: 2.5rem;">ğŸ” AE ìš©ì–´ì§‘ ì±—ë´‡</h1>
        <p style="color: #e6fff2; font-size: 1.3rem; margin-bottom: 1.5rem;">ë°˜ë„ì²´ AE ì „ë¬¸ ìš©ì–´ AI ì–´ì‹œìŠ¤í„´íŠ¸</p>
        <h4 style="color: white; text-align: center; margin-bottom: 1rem;">ğŸ” ë°˜ë„ì²´ AE ìš©ì–´ ì „ë¬¸ ê²€ìƒ‰</h4>
        <p style="margin-bottom: 0.5rem; color: white; text-align: center;">â€¢ ë°˜ë„ì²´ AE ì „ë¬¸ ìš©ì–´ ì •ì˜ ë° ì„¤ëª…</p>
        <p style="margin-bottom: 0.5rem; color: white; text-align: center;">â€¢ ê¸°ìˆ  ìš©ì–´ì˜ ì •í™•í•œ í•´ì„ ë° í™œìš©ë²•</p>
        <p style="margin-bottom: 0.5rem; color: white; text-align: center;">â€¢ ì—°ê´€ í‚¤ì›Œë“œ ë° ì°¸ê³  ìë£Œ ì œê³µ</p>
        <p style="margin-bottom: 0; color: white; text-align: center;">â€¢ ìš©ì–´ ì •ë³´ ë¶€ì¡± ì‹œ í•™ìŠµ ìš”ì²­ ê¸°ëŠ¥</p>
    </div>
    """, unsafe_allow_html=True)
    
    # ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
    if "glossary_chat_messages" not in st.session_state:
        st.session_state.glossary_chat_messages = []
        # ì´ˆê¸° ì¸ì‚¬ë§
        welcome_message = {
            "role": "assistant", 
            "content": """ì•ˆë…•í•˜ì„¸ìš”! AE ìš©ì–´ì§‘ ì „ë¬¸ ì±—ë´‡ì…ë‹ˆë‹¤. ğŸ”

ì €ëŠ” ë°˜ë„ì²´ AE(Application Engineering) ì „ë¬¸ ìš©ì–´ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

**ë„ì›€ì„ ë“œë¦´ ìˆ˜ ìˆëŠ” ë¶„ì•¼:**
- ğŸ”¬ ë°˜ë„ì²´ AE ì „ë¬¸ ìš©ì–´ ì •ì˜ ë° ì„¤ëª…
- ğŸ¯ ê¸°ìˆ  ìš©ì–´ì˜ ì •í™•í•œ í•´ì„ ë° í™œìš©ë²•
- ğŸ”— ì—°ê´€ í‚¤ì›Œë“œ ë° ì°¸ê³  ìë£Œ ì œê³µ
- ğŸ“ ìš©ì–´ ì •ë³´ ë¶€ì¡± ì‹œ í•™ìŠµ ìš”ì²­ ê¸°ëŠ¥
- ğŸ’¡ ì—…ë¬´ì— í•„ìš”í•œ ì „ë¬¸ ìš©ì–´ ì•ˆë‚´

ê¶ê¸ˆí•œ ë°˜ë„ì²´ ìš©ì–´ê°€ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ê²€ìƒ‰í•´ë³´ì„¸ìš”!

**ê²€ìƒ‰ ì˜ˆì‹œ:** "CMOSë€?", "DDR5 ë©”ëª¨ë¦¬", "FinFET ê¸°ìˆ " ë“±""",
            "timestamp": datetime.now().strftime("%H:%M:%S")
        }
        st.session_state.glossary_chat_messages.append(welcome_message)

    # ì±„íŒ… ë©”ì‹œì§€ í‘œì‹œ
    for message in st.session_state.glossary_chat_messages:
        with st.chat_message(message["role"]):
            if message["role"] == "assistant" and message.get("is_last_response"):
                # ë§ˆì§€ë§‰ ì‘ë‹µì—ë§Œ ìˆ˜ì •/ì¶”ê°€ ë²„íŠ¼ í‘œì‹œ
                st.markdown(message["content"])
                st.caption(f"â° {message['timestamp']}")
                
                # ìš©ì–´ ì¶”ê°€/ìˆ˜ì • í†µí•© ë²„íŠ¼
                col1, col2, col3 = st.columns([1, 2, 1])
                with col2:
                    if st.button("ğŸ“ ìš©ì–´ ì¶”ê°€/ìˆ˜ì •í•˜ê¸°", key=f"edit_add_{message['timestamp']}", use_container_width=True):
                        st.session_state.redirect_context = {
                            "from_page": "ìš©ì–´ì§‘",
                            "query": st.session_state.get("last_glossary_query", ""),
                            "response": message["content"],
                            "action": "edit_or_add"
                        }
                        st.switch_page("pages/5_âœ¨WIKI_í•™ìŠµì‹œí‚¤ê¸°.py")
            else:
                st.markdown(message["content"])
                st.caption(f"â° {message['timestamp']}")

    # ì±„íŒ… ì…ë ¥ ì²˜ë¦¬
    if prompt := st.chat_input("ê¶ê¸ˆí•œ ë°˜ë„ì²´ ìš©ì–´ë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”... (ì˜ˆ: CMOSë€ ë¬´ì—‡ì¸ê°€ìš”?)"):
        # ë§ˆì§€ë§‰ ì¿¼ë¦¬ ì €ì¥
        st.session_state.last_glossary_query = prompt
        
        # ì´ì „ ì‘ë‹µì˜ is_last_response í”Œë˜ê·¸ ì œê±°
        for msg in st.session_state.glossary_chat_messages:
            if "is_last_response" in msg:
                del msg["is_last_response"]
        
        # ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        timestamp = datetime.now().strftime("%H:%M:%S")
        st.session_state.glossary_chat_messages.append({
            "role": "user", 
            "content": prompt,
            "timestamp": timestamp
        })
        
        # ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
        with st.chat_message("user"):
            st.markdown(prompt)
            st.caption(f"â° {timestamp}")

        # AI ì‘ë‹µ ìƒì„± ë° í‘œì‹œ
        with st.chat_message("assistant"):
            # ì‘ë‹µ ìƒì„±
            from utils import get_user_id
            bot_response = get_chatbot_response(
                prompt, 
                chat_history=None,  # ë‹¨ìˆœí™”
                chatbot_type="glossary",
                user_id=get_user_id()
            )
            
            # AI ì‘ë‹µ í‘œì‹œ
            st.markdown(bot_response)
            response_timestamp = datetime.now().strftime("%H:%M:%S")
            st.caption(f"â° {response_timestamp}")
            
            # ìš©ì–´ ì¶”ê°€/ìˆ˜ì • í†µí•© ë²„íŠ¼
            col1, col2, col3 = st.columns([1, 2, 1])
            with col2:
                if st.button("ğŸ“ ìš©ì–´ ì¶”ê°€/ìˆ˜ì •í•˜ê¸°", key=f"edit_add_new_{response_timestamp}", use_container_width=True):
                    st.session_state.redirect_context = {
                        "from_page": "ìš©ì–´ì§‘",
                        "query": prompt,
                        "response": bot_response,
                        "action": "edit_or_add"
                    }
                    st.switch_page("pages/5_âœ¨WIKI_í•™ìŠµì‹œí‚¤ê¸°.py")

        # AI ì‘ë‹µì„ ì„¸ì…˜ ìƒíƒœì— ì €ì¥
        st.session_state.glossary_chat_messages.append({
            "role": "assistant",
            "content": bot_response,
            "timestamp": response_timestamp,
            "is_last_response": True
        })
        
        # ì±„íŒ… íˆìŠ¤í† ë¦¬ë¥¼ knowledge_data.jsonì— ì €ì¥
        save_chat_history(data, prompt, bot_response, chatbot_type="glossary")
        
    
    # ì‚¬ì´ë“œë°”: ì±„íŒ… ê´€ë¦¬ ë° ìš©ì–´ ê¸°ì—¬ ì•ˆë‚´
    with st.sidebar:
        st.markdown("### ğŸ”§ ì±„íŒ… ê´€ë¦¬")
        
        if st.button("ğŸ—‘ï¸ ëŒ€í™” ê¸°ë¡ ì´ˆê¸°í™”", use_container_width=True):
            st.session_state.glossary_chat_messages = []
            st.success("ëŒ€í™” ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!")
            time.sleep(0.5)
            st.rerun()
        
        st.markdown("---")
        
        # ìš©ì–´ ê¸°ì—¬ ì•ˆë‚´ë¬¸ (ì ‘ì„ ìˆ˜ ìˆëŠ” í˜•íƒœ)
        with st.expander("ğŸ“š ìš©ì–´ ê¸°ì—¬ ì‹œìŠ¤í…œ", expanded=False):
            st.markdown("""
            <div style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f9ff 100%); 
                       padding: 1rem; border-radius: 10px; border: 1px solid #10b981; margin-bottom: 1rem;">
                <h4 style="color: #78350f; margin-bottom: 0.5rem; font-weight: bold;">ğŸŒ± ë‚˜ë¬´ìœ„í‚¤ ìŠ¤íƒ€ì¼ ê¸°ì—¬</h4>
                <p style="color: #78350f; font-size: 0.9rem; margin-bottom: 0.5rem;">
                    <strong>ğŸ“ ìš©ì–´ ì¶”ê°€/ìˆ˜ì •í•˜ê¸°</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ë©´:
                </p>
                <ul style="color: #78350f; font-size: 0.85rem; margin-left: 1rem;">
                    <li>âœ¨ WIKI í•™ìŠµì‹œí‚¤ê¸° í˜ì´ì§€ë¡œ ì´ë™</li>
                    <li>ğŸ“‹ ê´€ë¦¬ìê°€ ê²€í†  í›„ ìŠ¹ì¸</li>
                    <li>ğŸ“… ë“±ë¡ìì™€ ë“±ë¡ì¼ì´ íˆìŠ¤í† ë¦¬ë¡œ ê¸°ë¡</li>
                    <li>ğŸ ìŠ¹ì¸ ì‹œ í¬ì¸íŠ¸ ì§€ê¸‰!</li>
                </ul>
            </div>
            """, unsafe_allow_html=True)
            
            st.markdown("""
            <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); 
                       padding: 1rem; border-radius: 10px; border: 1px solid #f59e0b; margin-bottom: 1rem;">
                <h4 style="color: #92400e; margin-bottom: 0.5rem;">ğŸ† ê¸°ì—¬ í˜œíƒ</h4>
                <ul style="color: #78350f; font-size: 0.85rem; margin-left: 1rem;">
                    <li>ğŸŒŸ ìš©ì–´ ë“±ë¡: <strong>+10 í¬ì¸íŠ¸</strong></li>
                    <li>ğŸ”§ ìš©ì–´ ìˆ˜ì •: <strong>+5 í¬ì¸íŠ¸</strong></li>
                    <li>ğŸ‘¤ ê¸°ì—¬ìëª… ì˜êµ¬ ê¸°ë¡</li>
                    <li>ğŸ“Š ê°œì¸ ê¸°ì—¬ë„ í†µê³„ ì œê³µ</li>
                </ul>
            </div>
            """, unsafe_allow_html=True)
            
            st.markdown("""
            <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); 
                       padding: 1rem; border-radius: 10px; border: 1px solid #6366f1;">
                <p style="color: #78350f; font-size: 0.8rem; text-align: center; margin: 0;">
                    ğŸ’¡ <strong>íŒ:</strong> ì •í™•í•˜ê³  ìœ ìš©í•œ ìš©ì–´ì¼ìˆ˜ë¡<br>
                    ë” ë§ì€ í¬ì¸íŠ¸ë¥¼ ë°›ì„ ìˆ˜ ìˆì–´ìš”!
                </p>
            </div>
            """, unsafe_allow_html=True)


def show_edit_add_buttons(response_content, msg_index, timestamp):
    """ìˆ˜ì •/ì¶”ê°€ ë²„íŠ¼ í‘œì‹œ"""
    st.markdown("### ğŸ› ï¸ ë‹µë³€ ê°œì„ í•˜ê¸°")
    
    # ê³ ìœ  í‚¤ ìƒì„±ì„ ìœ„í•´ ì¸ë±ìŠ¤ì™€ íƒ€ì„ìŠ¤íƒ¬í”„ ì‚¬ìš©
    unique_key_suffix = f"{msg_index}_{timestamp.replace(':', '').replace(' ', '_')}"
    
    # ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ ì»¬ëŸ¼ êµ¬ì„±
    col1, col2, col3 = st.columns([1, 2, 1])
    
    with col2:
        if st.button("ğŸ”§ ìˆ˜ì •/ì¶”ê°€í•˜ê¸°", use_container_width=True, key=f"edit_add_{unique_key_suffix}"):
            # WIKI í•™ìŠµ í˜ì´ì§€ì˜ ìš©ì–´ í•™ìŠµ íƒ­ìœ¼ë¡œ ì´ë™
            st.session_state['redirect_to_wiki_term'] = "edit_add"
            st.session_state['edit_content'] = response_content
            st.switch_page("pages/5_âœ¨WIKI_í•™ìŠµì‹œí‚¤ê¸°.py")
    
    st.markdown("""
    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); 
               border: 1px solid #42a5f5; padding: 0.8rem; border-radius: 8px; 
               margin-top: 0.5rem; font-size: 0.9rem; color: #1565c0;">
        ğŸ’¡ <strong>ë„ì›€ë§:</strong> 
        ë‹µë³€ì´ ë¶€ì •í™•í•˜ê±°ë‚˜ ë¶€ì¡±í•œ ê²½ìš° í´ë¦­í•˜ì—¬ WIKIì— ì •ë³´ë¥¼ ìˆ˜ì •/ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        ë²„íŠ¼ í´ë¦­ ì‹œ WIKI í•™ìŠµ í˜ì´ì§€ì˜ ğŸ“ ìš©ì–´ í•™ìŠµì‹œí‚¤ê¸° íƒ­ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.
    </div>
    """, unsafe_allow_html=True)

def display_text_gradually(text, container):
    """ê°„ë‹¨í•œ íƒ€ì´í•‘ íš¨ê³¼ - ì„±ëŠ¥ ìµœì í™” ë° ì‚¬ìš©ì ì„¤ì • ë°˜ì˜"""
    # ì‚¬ìš©ì ì„¤ì • í™•ì¸
    typing_enabled = st.session_state.get("typing_enabled", True)
    speed_setting = st.session_state.get("response_speed", "fast")
    
    if not typing_enabled or len(text) > 300:  # íƒ€ì´í•‘ ë¹„í™œì„±í™” ë˜ëŠ” ê¸´ í…ìŠ¤íŠ¸ëŠ” ë°”ë¡œ í‘œì‹œ
        container.markdown(text)
        return
    
    # ì†ë„ ì„¤ì •ì— ë”°ë¥¸ ë”œë ˆì´ ì¡°ì • - ìµœëŒ€í•œ ë¹ ë¥´ê²Œ
    speed_delays = {"fast": 0.001, "normal": 0.005, "slow": 0.01}
    delay = speed_delays.get(speed_setting, 0.001)
    
    words = text.split()
    displayed_text = ""
    
    for word in words:
        displayed_text += word + " "
        container.markdown(displayed_text)
        time.sleep(delay * 2)  # ë‹¨ì–´ ë‹¨ìœ„

# ====================================
# ğŸš€ ì•± ì‹¤í–‰
# ====================================

def display_glossary_response_with_cards(response_text):
    """ìš©ì–´ì§‘ ì‘ë‹µì„ í™•ì¥ ê°€ëŠ¥í•œ ë©”íƒ€ë°ì´í„° ì¹´ë“œë¡œ í‘œì‹œ"""
    # ì‘ë‹µì„ íŒŒì‹±í•´ì„œ ë©”ì¸ ë‚´ìš©ê³¼ ì¶œì²˜/ë©”íƒ€ë°ì´í„° ë¶„ë¦¬
    lines = response_text.split('\n')
    main_content = []
    source_info = []
    
    # ì¶œì²˜ ì„¹ì…˜ ì°¾ê¸° (--- ë˜ëŠ” ğŸ“š **ì°¸ê³  ë¬¸ì„œ** ë“±)
    in_sources = False
    for line in lines:
        if '---' in line or 'ğŸ“š' in line or 'ì°¸ê³  ë¬¸ì„œ' in line or 'ì¶œì²˜' in line:
            in_sources = True
            continue
        if in_sources:
            if line.strip():
                source_info.append(line.strip())
        else:
            main_content.append(line)
    
    # ë©”ì¸ ë‚´ìš© í‘œì‹œ
    if main_content:
        st.markdown('\n'.join(main_content))
    
    # ì¶œì²˜ ì •ë³´ê°€ ìˆìœ¼ë©´ í™•ì¥ ê°€ëŠ¥í•œ ì¹´ë“œë¡œ í‘œì‹œ
    if source_info:
        with st.expander("ğŸ“‹ ìƒì„¸ ë©”íƒ€ë°ì´í„° ë° ì¶œì²˜", expanded=False):
            for i, source in enumerate(source_info, 1):
                if source.strip():
                    # ê°œë³„ ì¶œì²˜ë¥¼ ì¹´ë“œ í˜•íƒœë¡œ í‘œì‹œ
                    with st.container():
                        st.markdown(f"""
                        <div style="background-color: #2d3748; border-left: 4px solid #20c997; 
                                   padding: 1rem; margin: 0.5rem 0; border-radius: 8px;">
                            <div style="font-weight: bold; color: #20c997; margin-bottom: 0.5rem;">
                                ğŸ“„ ì°¸ê³  ë¬¸ì„œ {i}
                            </div>
                            <div style="color: #e1e5e9;">
                                {source}
                            </div>
                        </div>
                        """, unsafe_allow_html=True)

if __name__ == "__main__":
    main()